<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Prezentacja laureatów</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Czcionki UniSansHeavyCAPS – korzystamy z plików OTF skopiowanych do katalogu fonts/ -->
  <style>
    @font-face {
      font-family: "UniSansHeavyCAPS";
      src: url("fonts/Uni Sans Heavy.otf") format("opentype");
      font-weight: 400;
      font-style: normal;
    }

    @font-face {
      font-family: "UniSansHeavyCAPS";
      src: url("fonts/Uni Sans Heavy.otf") format("opentype");
      font-weight: 700;
      font-style: normal;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }

    body {
      font-family: "UniSansHeavyCAPS", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #000;
    }

    #app {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    /* Warstwa wideo w tle */
    #video-layer {
      position: absolute;
      inset: 0;
      overflow: hidden;
      z-index: 0;
      background: #000;
    }

    #video-layer video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.6s ease;
    }

    #video-title-bg.visible,
    #video-winners-bg.visible {
      opacity: 1;
    }

    /* Warstwa treści (slajdy) */
    #slide-layer {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4vh 6vw;
      pointer-events: none; /* slajd nie reaguje na kliknięcia, tylko klawisze */
    }

    .slide-content {
      max-width: 80vw;
      max-height: 90vh;
      text-align: center;
      color: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 3vh;
      word-wrap: break-word;
      overflow: visible;
      perspective: 1000px;
    }


    .slide-title {
      font-weight: 700;
      font-size: min(7vh, 5vw);
      line-height: 1.35;
      padding-top: 0.1em;
    }

    .slide-subtitle {
      font-weight: 400;
      font-size: min(4.5vh, 3.4vw);
      line-height: 1.35;
      padding-top: 0.1em;
    }

    .winners-header {
      font-weight: 700;
      font-size: min(5vh, 3.6vw);
      line-height: 1.35;
      padding-top: 0.1em;
      margin-bottom: 2vh;
    }

    .winners-list {
      display: flex;
      flex-direction: column;
      gap: 2vh;
      align-items: center;
    }

    .winner {
      max-width: 80vw;
    }

    .winner-name {
      font-weight: 700;
      font-size: min(5.5vh, 4vw);
      line-height: 1.35;
      padding-top: 0.1em;
    }

    .winner-details {
      font-weight: 400;
      font-size: min(3.5vh, 2.6vw);
      line-height: 1.35;
      padding-top: 0.1em;
      margin-top: 0.8vh;
    }


    /* Ekran ładowania */
    #loading-overlay {
      position: absolute;
      inset: 0;
      z-index: 5;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #fff;
      text-align: center;
    }

    #loading-overlay.hidden {
      display: none;
    }

    .loader {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Ekran startowy */
    #start-overlay {
      position: absolute;
      inset: 0;
      z-index: 2;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #fff;
      text-align: center;
      padding: 2rem;
    }

    #start-overlay.visible {
      display: flex;
    }

    #start-overlay h1 {
      font-family: "UniSansHeavyCAPS", sans-serif;
      font-weight: 700;
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    #start-overlay p {
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
      max-width: 32rem;
    }

    #start-button {
      pointer-events: auto;
      cursor: pointer;
      border: none;
      font-family: "UniSansHeavyCAPS", sans-serif;
      font-weight: 700;
      font-size: 1.4rem;
      padding: 0.9rem 2.4rem;
      border-radius: 999px;
      background: #ffffff;
      color: #000000;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    #start-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.5);
    }

    #start-button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    }

    #download-offline-button {
      pointer-events: auto;
      cursor: pointer;
      display: inline-block;
      margin-top: 1rem;
      border: none;
      text-decoration: none;
      font-family: "UniSansHeavyCAPS", sans-serif;
      font-weight: 700;
      font-size: 1rem;
      padding: 0.7rem 1.8rem;
      border-radius: 999px;
      background: #ffffff;
      color: #000000;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    #download-offline-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.5);
    }

    #download-offline-button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    }

    /* Fade sequence – początkowo ukryte, animowane JS-em */
    .fade-seq {
      opacity: 0;
      transform: translateY(10px);
    }

    /* Komunikat błędu ładowania */
    #error-message {
      position: absolute;
      inset: 0;
      z-index: 3;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 1.1rem;
    }

    #error-message.visible {
      display: flex;
    }
  </style>

  <!-- anime.js – biblioteka do animacji (do obejrzenia/modyfikacji) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" defer></script>

  <script>
    // Dane tylko z Google Sheets (online)
    const SHEET_ID = "1_4ZEm_I27_I0c6Gnlr2Ffs3lUg8alIcEwrHCzwXwysk";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

    let contests = [];
    let slides = [];
    let currentSlideIndex = 0;
    let presentationStarted = false;
    // Funkcja do usuwania sierotek (w, z, i, o, u, a itp.) - zamienia spację po nich na &nbsp;
    function fixOrphans(text) {
      // Lista polskich spójników/przyimków które nie powinny zostawać na końcu linii
      const orphans = ['a', 'i', 'o', 'u', 'w', 'z', 'do', 'na', 'po', 'za', 'od', 'we', 'ze', 'ku', 'o', 'nr', 'im.', 'woj.'];
      let result = text;
      orphans.forEach(word => {
        // Szukamy słowa otoczonego spacjami (lub na początku) i zamieniamy spację po nim na nbsp
        const regex = new RegExp(`(^|\\s)(${word.replace('.', '\\.')})\\s`, 'gi');
        result = result.replace(regex, `$1$2\u00A0`);
      });
      return result;
    }

    function showError(message) {
      const el = document.getElementById("error-message");
      el.textContent = message;
      el.classList.add("visible");
    }

    async function fetchSheetData() {
      const res = await fetch(SHEET_URL);
      if (!res.ok) {
        throw new Error("Nie udało się wczytać danych z Google Sheets");
      }
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
      const data = JSON.parse(jsonStr);
      return data.table;
    }

    function parseContestsFromTable(table) {
      const cols = table.cols || [];
      const rows = table.rows || [];

      // Najpierw spróbuj znaleźć kolumny po label
      function findColByLabel(label) {
        return cols.findIndex(c => (c.label || "").trim().toLowerCase() === label.toLowerCase());
      }

      let idxName = findColByLabel("nazwa_konkursu");
      let idxOrg = findColByLabel("organizator");
      let idxWinnerName = findColByLabel("imiona_nazwiska_laureata");
      let idxSchool = findColByLabel("nazwa_szkoly");
      let idxRegion = findColByLabel("wojewodztwo");

      let dataRows = rows;

      // Jeśli label są puste, pierwszy wiersz to nagłówki
      if (idxName === -1 && rows.length > 0) {
        const firstRow = rows[0].c || [];
        const headers = firstRow.map(cell => (cell && cell.v != null ? String(cell.v).trim().toLowerCase() : ""));
        
        idxName = headers.indexOf("nazwa_konkursu");
        idxOrg = headers.indexOf("organizator");
        idxWinnerName = headers.indexOf("imiona_nazwiska_laureata");
        idxSchool = headers.indexOf("nazwa_szkoly");
        idxRegion = headers.indexOf("wojewodztwo");
        
        // Pomiń pierwszy wiersz (nagłówki)
        dataRows = rows.slice(1);
      }

      if (idxName === -1 || idxOrg === -1 || idxWinnerName === -1 || idxSchool === -1 || idxRegion === -1) {
        throw new Error("Nie znaleziono oczekiwanych nagłówków kolumn w arkuszu.");
      }

      const result = [];
      let currentContest = null;

      for (const row of dataRows) {
        const c = row.c || [];
        const nameVal = c[idxName] && c[idxName].v != null ? String(c[idxName].v).trim() : "";
        const orgVal = c[idxOrg] && c[idxOrg].v != null ? String(c[idxOrg].v).trim() : "";
        const winnerNameVal = c[idxWinnerName] && c[idxWinnerName].v != null ? String(c[idxWinnerName].v).trim() : "";
        const schoolVal = c[idxSchool] && c[idxSchool].v != null ? String(c[idxSchool].v).trim() : "";
        const regionVal = c[idxRegion] && c[idxRegion].v != null ? String(c[idxRegion].v).trim() : "";

        const allEmpty = !nameVal && !orgVal && !winnerNameVal && !schoolVal && !regionVal;
        if (allEmpty) continue;

        // Jeśli wiersz ma nazwę konkursu -> nowy konkurs
        if (nameVal) {
          if (currentContest) {
            result.push(currentContest);
          }
          currentContest = {
            title: nameVal,
            organizer: orgVal,
            winners: []
          };
        }

        if (!currentContest) continue;

        if (winnerNameVal) {
          currentContest.winners.push({
            name: winnerNameVal,
            school: schoolVal,
            region: regionVal
          });
        }
      }

      if (currentContest) {
        result.push(currentContest);
      }

      return result;
    }

    function buildSlidesFromContests(contests) {
      const generatedSlides = [];
      for (const contest of contests) {
        generatedSlides.push({ type: "title", contest });
        generatedSlides.push({ type: "winners", contest });
      }
      return generatedSlides;
    }

    function setBackgroundForSlide(slide) {
      const titleVideo = document.getElementById("video-title-bg");
      const winnersVideo = document.getElementById("video-winners-bg");

      if (slide.type === "title") {
        titleVideo.classList.add("visible");
        winnersVideo.classList.remove("visible");
      } else {
        winnersVideo.classList.add("visible");
        titleVideo.classList.remove("visible");
      }
    }

    function createTitleSlideContent(contest) {
      const container = document.createElement("div");
      container.className = "slide-content";

      const titleEl = document.createElement("div");
      titleEl.className = "slide-title fade-seq";
      titleEl.innerHTML = fixOrphans(contest.title || "(bez tytułu)");

      const subtitleEl = document.createElement("div");
      subtitleEl.className = "slide-subtitle fade-seq";
      subtitleEl.innerHTML = fixOrphans(contest.organizer || "");

      container.appendChild(titleEl);
      container.appendChild(subtitleEl);

      return container;
    }

    function createWinnersSlideContent(contest) {
      const container = document.createElement("div");
      container.className = "slide-content";

      const winnersCount = contest.winners.length;
      const headerText = winnersCount === 1 ? "Zwycięzca" : "Zwycięzcy";

      const headerEl = document.createElement("div");
      headerEl.className = "winners-header fade-seq";
      headerEl.textContent = headerText;

      const winnersListEl = document.createElement("div");
      winnersListEl.className = "winners-list";

      contest.winners.forEach((w) => {
        const item = document.createElement("div");
        item.className = "winner fade-seq";

        const nameEl = document.createElement("div");
        nameEl.className = "winner-name";
        nameEl.innerHTML = fixOrphans(w.name);

        const detailsEl = document.createElement("div");
        detailsEl.className = "winner-details";
        const regionText = w.region ? `woj.\u00A0${w.region}` : "";
        const detailsParts = [w.school, regionText].filter(Boolean);
        detailsEl.innerHTML = fixOrphans(detailsParts.join(" • "));

        item.appendChild(nameEl);
        item.appendChild(detailsEl);
        winnersListEl.appendChild(item);
      });

      container.appendChild(headerEl);
      container.appendChild(winnersListEl);

      return container;
    }

    // Funkcja animacji – płynne wejście z efektem scale
    let currentAnimation = null;

    function fadeInSequence(elements, options = {}) {
      // Anuluj poprzednią animację jeśli trwa
      if (currentAnimation) {
        currentAnimation.pause();
        currentAnimation = null;
      }

      if (!window.anime || !elements.length) return;

      // Ustaw stan początkowy
      elements.forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(50px) scale(0.9)';
      });

      currentAnimation = anime({
        targets: Array.from(elements),
        opacity: [0, 1],
        translateY: [50, 0],
        scale: [0.9, 1],
        easing: 'easeOutExpo',
        duration: 800,
        delay: anime.stagger(150),
        complete: () => {
          currentAnimation = null;
        }
      });
    }

    function renderCurrentSlide() {
      const slide = slides[currentSlideIndex];
      const slideLayer = document.getElementById("slide-layer");

      slideLayer.innerHTML = "";

      let content;
      if (slide.type === "title") {
        content = createTitleSlideContent(slide.contest);
      } else {
        content = createWinnersSlideContent(slide.contest);
      }

      slideLayer.appendChild(content);
      setBackgroundForSlide(slide);

      const animatables = slideLayer.querySelectorAll(".fade-seq");
      fadeInSequence(animatables);
    }

    function nextSlide() {
      if (!presentationStarted) return;
      if (currentSlideIndex < slides.length - 1) {
        currentSlideIndex += 1;
        renderCurrentSlide();
      }
    }

    function prevSlide() {
      if (!presentationStarted) return;
      if (currentSlideIndex > 0) {
        currentSlideIndex -= 1;
        renderCurrentSlide();
      }
    }

    function goToFirstSlide() {
      if (!presentationStarted) return;
      currentSlideIndex = 0;
      renderCurrentSlide();
    }

    function goToLastSlide() {
      if (!presentationStarted) return;
      currentSlideIndex = slides.length - 1;
      renderCurrentSlide();
    }

    function setupKeyboardNavigation() {
      window.addEventListener("keydown", (e) => {
        if (!presentationStarted) return;

        switch (e.key) {
          case "ArrowRight":
          case "ArrowDown":
          case "PageDown":
          case " ":
            e.preventDefault();
            nextSlide();
            break;
          case "ArrowLeft":
          case "ArrowUp":
          case "PageUp":
            e.preventDefault();
            prevSlide();
            break;
          case "Home":
            e.preventDefault();
            goToFirstSlide();
            break;
          case "End":
            e.preventDefault();
            goToLastSlide();
            break;
        }
      });
    }

    async function startPresentation() {
      const startOverlay = document.getElementById("start-overlay");
      startOverlay.style.display = "none";
      presentationStarted = true;

      if (!slides.length) {
        showError("Brak slajdów do wyświetlenia.");
        return;
      }

      currentSlideIndex = 0;
      renderCurrentSlide();

      // Uruchom polling co 10 sekund
      startPolling();
    }

    // Polling - odświeżanie danych co 10 sekund
    const POLLING_INTERVAL = 10000; // 10 sekund
    let pollingTimer = null;

    function startPolling() {
      if (pollingTimer) return; // już działa
      pollingTimer = setInterval(refreshData, POLLING_INTERVAL);
    }

    async function refreshData() {
      try {
        const table = await fetchSheetData();
        const newContests = parseContestsFromTable(table);
        const newSlides = buildSlidesFromContests(newContests);

        if (newSlides.length > 0) {
          // Zapamiętaj aktualny konkurs i typ slajdu
          const currentSlide = slides[currentSlideIndex];
          const currentContestTitle = currentSlide ? currentSlide.contest.title : null;
          const currentSlideType = currentSlide ? currentSlide.type : null;

          // Zaktualizuj dane
          contests = newContests;
          slides = newSlides;

          // Spróbuj znaleźć ten sam slajd po aktualizacji
          let newIndex = -1;
          if (currentContestTitle) {
            newIndex = slides.findIndex(
              s => s.contest.title === currentContestTitle && s.type === currentSlideType
            );
          }
          
          if (newIndex !== -1) {
            currentSlideIndex = newIndex;
          } else {
            // Konkurs został usunięty - ustaw bezpieczny indeks
            const safeIndex = Math.min(currentSlideIndex, Math.max(0, slides.length - 1));
            if (safeIndex !== currentSlideIndex) {
              currentSlideIndex = safeIndex;
              // Przerenderuj tylko jeśli indeks się zmienił (konkurs usunięty)
              if (presentationStarted && slides.length > 0) {
                renderCurrentSlide();
              }
            }
          }

          // NIE renderujemy slajdu przy każdym pollingu - tylko aktualizujemy dane
          // Slajd zostanie odświeżony przy następnej nawigacji
          console.log("Dane odświeżone z Google Sheets");
        }
      } catch (err) {
        // Cicha porażka - zachowaj poprzednie dane
        console.warn("Nie udało się odświeżyć danych, używam poprzednich:", err.message);
      }
    }

    function requestFullscreenForPresentation() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        return elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        return elem.webkitRequestFullscreen();
      } else if (elem.mozRequestFullScreen) {
        return elem.mozRequestFullScreen();
      } else if (elem.msRequestFullscreen) {
        return elem.msRequestFullscreen();
      }
      return Promise.resolve();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      setupKeyboardNavigation();

      const loadingOverlay = document.getElementById("loading-overlay");
      const startOverlay = document.getElementById("start-overlay");
      const startButton = document.getElementById("start-button");
      const video1 = document.getElementById("video-title-bg");
      const video2 = document.getElementById("video-winners-bg");

      startButton.addEventListener("click", async () => {
        try {
          await requestFullscreenForPresentation();
        } catch (e) {
          console.warn("Fullscreen error:", e);
        }
        startPresentation();
      });

      // Funkcja sprawdzająca czy wideo jest załadowane
      function videoReady(video) {
        return new Promise((resolve) => {
          if (video.readyState >= 3) {
            resolve();
          } else {
            video.addEventListener('canplaythrough', resolve, { once: true });
            // Timeout na wypadek problemów
            setTimeout(resolve, 5000);
          }
        });
      }

      try {
        // Równolegle: ładuj dane i wideo
        const dataPromise = (async () => {
          const table = await fetchSheetData();
          contests = parseContestsFromTable(table);
          slides = buildSlidesFromContests(contests);
        })();

        const videoPromise = Promise.all([videoReady(video1), videoReady(video2)]);

        await Promise.all([dataPromise, videoPromise]);

        // Pokaż bg-1 na ekranie startowym
        video1.classList.add("visible");
        video2.classList.remove("visible");

        // Schowaj loader, pokaż ekran startowy
        loadingOverlay.classList.add("hidden");
        startOverlay.classList.add("visible");

        if (!slides.length) {
          showError("Nie znaleziono żadnych konkursów w danych.");
        }
      } catch (err) {
        console.error("Błąd ładowania", err);
        loadingOverlay.classList.add("hidden");
        showError("Błąd podczas wczytywania danych.");
      }
    });
  </script>
</head>
<body>
  <div id="app">
    <!-- Ekran ładowania -->
    <div id="loading-overlay">
      <div class="loader"></div>
    </div>

    <!-- Tło wideo -->
    <div id="video-layer">
      <video
        id="video-title-bg"
        src="bg-1.mp4"
        autoplay
        muted
        loop
        playsinline
        preload="auto"
      ></video>

      <video
        id="video-winners-bg"
        src="bg-2.mp4"
        autoplay
        muted
        loop
        playsinline
        preload="auto"
      ></video>
    </div>

    <!-- Warstwa slajdów -->
    <div id="slide-layer"></div>

    <!-- Ekran startowy -->
    <div id="start-overlay">
      <h1>Prezentacja laureatów</h1>
      <p>
        Kliknij „Start prezentacji”, aby wejść w tryb pełnoekranowy.
        Następnie używaj klawiszy strzałek (jak w PowerPoincie), aby przechodzić między slajdami.
      </p>
      <button id="start-button">Start prezentacji</button>
      <a id="download-offline-button" href="prezentacja-offline.zip" download>
        Ściągnij prezentację (offline, snapshot z Google Sheets)
      </a>
    </div>

    <!-- Komunikat błędu -->
    <div id="error-message"></div>
  </div>
</body>
</html>
